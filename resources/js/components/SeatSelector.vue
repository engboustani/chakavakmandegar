<template>
          <div class="row">
              <div class="col-12">
              <el-progress :percentage="timeShop"></el-progress>

              </div>
              <div class="col-12 text-xs-center">
                <svg id="x" width="640" height="480" xmlns="http://www.w3.org/2000/svg">
                    <g board>
                     <rect stage height="80.38871" width="126.153836" y="206.825647" x="206.459768"/>
                     <rect zoom-control="right" height="80.175489" width="57.875103" y="205.119891" x="338.511515"/>
                     <rect zoom-control="main" height="95.687786" width="126.854046" y="105.769235" x="206.180359"/>
                     <rect zoom-control="left" height="79.962273" width="57.448662" y="205.119891" x="142.930951"/>
                     <g seating-area="left" zoom-target="left">
                      <rect id="1" seat height="14.560438" width="13" y="206.529233" x="158.181482"/>
                      <rect id="2" seat height="14.560438" width="13" y="206.529233" x="172.049076"/>
                      <rect id="3" seat height="14.560438" width="13" y="206.475552" x="185.969085"/>
                      <rect id="4" seat height="14.560438" width="13" y="222.073274" x="158.00877"/>
                      <rect id="5" seat="5" height="14.560438" width="13" y="222.073274" x="171.876365"/>
                      <rect id="6" seat="5" height="14.560438" width="13" y="222.019593" x="185.796374"/>
                      <rect id="7" seat height="14.560438" width="13" y="237.625949" x="158.00877"/>
                      <rect id="8" seat="5" height="14.560438" width="13" y="237.625949" x="171.876365"/>
                      <rect id="9" seat height="14.560438" width="13" y="237.572268" x="185.796374"/>
                      <rect id="10" seat height="14.560438" width="13" y="253.267808" x="158.00877"/>
                      <rect id="11" seat height="14.560438" width="13" y="253.267808" x="171.876365"/>
                      <rect id="12" seat height="14.560438" width="13" y="253.214127" x="185.796374"/>
                      <rect id="13" seat height="14.560438" width="13" y="268.98551" x="158.00877"/>
                      <rect id="14" seat height="14.560438" width="13" y="268.98551" x="171.876365"/>
                      <rect id="15" seat height="14.560438" width="13" y="268.931829" x="185.796374"/>
                      <rect id="16" seat height="14.560438" width="13" y="206.529233" x="144.13066"/>
                      <rect id="17" seat height="14.560438" width="13" y="222.073274" x="143.957949"/>
                      <rect id="18" seat height="14.560438" width="13" y="237.625949" x="143.957949"/>
                      <rect id="19" seat height="14.560438" width="13" y="253.267808" x="143.957949"/>
                      <rect id="20" seat height="14.560438" width="13" y="268.98551" x="143.957949"/>
                     </g>
                     <g seating-area="right" zoom-target="right">
                      <rect id="21" seat height="14.560438" width="13" y="206.529233" x="354.251359"/>
                      <rect id="22" seat height="14.560438" width="13" y="206.529233" x="368.118954"/>
                      <rect id="23" seat height="14.560438" width="13" y="206.475552" x="382.038963"/>
                      <rect id="24" seat height="14.560438" width="13" y="222.073275" x="354.078648"/>
                      <rect id="25" seat height="14.560438" width="13" y="222.073275" x="367.946242"/>
                      <rect id="26" seat height="14.560438" width="13" y="222.019594" x="381.866251"/>
                      <rect id="27" seat height="14.560438" width="13" y="237.62595" x="354.078648"/>
                      <rect id="28" seat height="14.560438" width="13" y="237.62595" x="367.946242"/>
                      <rect id="29" seat height="14.560438" width="13" y="237.572269" x="381.866251"/>
                      <rect id="30" seat height="14.560438" width="13" y="253.267808" x="354.078648"/>
                      <rect id="31" seat height="14.560438" width="13" y="253.267808" x="367.946242"/>
                      <rect id="32" seat height="14.560438" width="13" y="253.214127" x="381.866251"/>
                      <rect id="33" seat height="14.560438" width="13" y="268.98551" x="354.078648"/>
                      <rect id="34" seat height="14.560438" width="13" y="268.98551" x="367.946242"/>
                      <rect id="35" seat height="14.560438" width="13" y="268.931829" x="381.866251"/>
                      <rect id="36" seat height="14.560438" width="13" y="206.529233" x="340.200538"/>
                      <rect id="37" seat height="14.560438" width="13" y="222.073275" x="340.027826"/>
                      <rect id="38" seat height="14.560438" width="13" y="237.62595" x="340.027826"/>
                      <rect id="39" seat height="14.560438" width="13" y="253.267808" x="340.027826"/>
                      <rect id="40" seat height="14.560438" width="13" y="268.98551" x="340.027826"/>
                     </g>
                     <g seating-area="main" zoom-target="main">
                      <rect id="" seat class="reserved" height="14.560438" width="13" y="106.863558" x="207.345423"/>
                      <rect id="" seat class="locked" height="14.560438" width="13" y="106.863558" x="221.213018"/>
                      <rect id="" seat height="14.560438" width="13" y="106.809877" x="235.133027"/>
                      <rect id="" seat height="14.560438" width="13" y="106.809877" x="290.701753"/>
                      <rect id="" seat height="14.560438" width="13" y="106.809877" x="304.569347"/>
                      <rect id="" seat height="14.560438" width="13" y="106.809877" x="318.526476"/>
                      <rect id="" seat height="14.560438" width="13" y="122.407599" x="207.172712"/>
                      <rect id="" seat height="14.560438" width="13" y="122.407599" x="221.040306"/>
                      <rect id="" seat height="14.560438" width="13" y="122.353918" x="234.960315"/>
                      <rect id="" seat height="14.560438" width="13" y="122.353918" x="248.82791"/>
                      <rect id="" seat height="14.560438" width="13" y="122.407599" x="262.741437"/>
                      <rect id="" seat height="14.560438" width="13" y="122.407599" x="276.609032"/>
                      <rect id="" seat height="14.560438" width="13" y="122.353918" x="290.529041"/>
                      <rect id="" seat height="14.560438" width="13" y="122.353918" x="304.396636"/>
                      <rect id="" seat height="14.560438" width="13" y="122.353918" x="318.353765"/>
                      <rect id="" seat height="14.560438" width="13" y="137.960275" x="207.172712"/>
                      <rect id="" seat height="14.560438" width="13" y="137.960275" x="221.040306"/>
                      <rect id="" seat height="14.560438" width="13" y="137.906594" x="234.960315"/>
                      <rect id="" seat height="14.560438" width="13" y="137.906594" x="248.82791"/>
                      <rect id="" seat height="14.560438" width="13" y="137.960275" x="262.741437"/>
                      <rect id="" seat height="14.560438" width="13" y="137.960275" x="276.609032"/>
                      <rect id="" seat height="14.560438" width="13" y="137.906594" x="290.529041"/>
                      <rect id="" seat height="14.560438" width="13" y="137.906594" x="304.396636"/>
                      <rect id="" seat height="14.560438" width="13" y="137.906594" x="318.353765"/>
                      <rect id="" seat height="14.560438" width="13" y="153.602133" x="207.172712"/>
                      <rect id="" seat height="14.560438" width="13" y="153.602133" x="221.040306"/>
                      <rect id="" seat height="14.560438" width="13" y="153.548452" x="234.960315"/>
                      <rect id="" seat height="14.560438" width="13" y="153.548452" x="248.82791"/>
                      <rect id="" seat height="14.560438" width="13" y="153.602133" x="262.741437"/>
                      <rect id="" seat height="14.560438" width="13" y="153.602133" x="276.609032"/>
                      <rect id="" seat height="14.560438" width="13" y="153.548452" x="290.529041"/>
                      <rect id="" seat height="14.560438" width="13" y="153.548452" x="304.396636"/>
                      <rect id="" seat height="14.560438" width="13" y="153.548452" x="318.353765"/>
                      <rect id="" seat height="14.560438" width="13" y="169.319835" x="207.172712"/>
                      <rect id="" seat height="14.560438" width="13" y="169.319835" x="221.040306"/>
                      <rect id="" seat height="14.560438" width="13" y="169.266154" x="234.960315"/>
                      <rect id="" seat height="14.560438" width="13" y="169.266154" x="248.82791"/>
                      <rect id="" seat height="14.560438" width="13" y="169.319835" x="262.741437"/>
                      <rect id="" seat height="14.560438" width="13" y="169.319835" x="276.609032"/>
                      <rect id="" seat height="14.560438" width="13" y="169.266154" x="290.529041"/>
                      <rect id="" seat height="14.560438" width="13" y="169.266154" x="304.396636"/>
                      <rect id="" seat height="14.560438" width="13" y="169.266154" x="318.353765"/>
                      <rect id="" seat height="14.560438" width="13" y="185.210239" x="221.040306"/>
                      <rect id="" seat height="14.560438" width="13" y="185.156558" x="234.960315"/>
                      <rect id="" seat height="14.560438" width="13" y="185.156558" x="248.82791"/>
                      <rect id="" seat height="14.560438" width="13" y="185.210239" x="262.741437"/>
                      <rect id="" seat height="14.560438" width="13" y="185.210239" x="276.609032"/>
                      <rect id="" seat height="14.560438" width="13" y="185.156558" x="290.529041"/>
                      <rect id="" seat height="14.560438" width="13" y="185.156558" x="304.396636"/>
                     </g>
                    </g>
                   </svg>
                   </div>
                   <div class="col-12 text-xs-center">
                        <el-button v-on:click="goBack()">برگشت</el-button>
                    </div>
            <div class="col-12">
                <h3 class="my-3"><i class="el-icon-s-fold mr-2"></i>لیست بلیت‌ها</h3>
                <div class="row">
                    <Ticket v-for="ticket in listTickets" :key="ticket.id" :ticket="ticket"></Ticket>
                    <div class="col-12" v-if="listTickets.length == 0">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                مکانی انتخاب نشده است.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12" v-if="listTickets.length > 0">
                <h3 class="my-3"><i class="el-icon-s-finance mr-2"></i>پرداخت</h3>
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5><i class="el-icon-s-claim mr-2"></i>فاکتور</h5>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-10">{{constructor(listTickets.length)}}x بلیت</div>
                                        <div class="col-2">{{ constructor(totalPrice) }} تومان</div>
                                    </div>
                                </li>
                                <li class="list-group-item disabled" aria-disabled="true">
                                    <div class="row">
                                        <div class="col-10">تخفیف</div>
                                        <div class="col-2">{{constructor(0)}} تومان</div>
                                    </div>
                                </li>
                            </ul>
                            <div class="card-footer">
                                <h6>مجموع: {{constructor(totalPrice)}} تومان</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5>تخفیف</h5>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="form-group">
                                        <label for="discountCode">کد تخفیف</label>
                                        <input type="text" class="form-control" id="discountCode">
                                    </div>
                                    <el-button class="float-right">اعمال</el-button>
                                </form>
                            </div>
                        </div>                        
                    </div>
                    <div class="col-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5>پرداخت</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="pb-1">مبلغ فاکتور: {{ constructor(totalPrice) }} تومان</h6>
                                <h6 class="pb-1">اعتبار شما: {{ constructor(credit) }} تومان</h6>
                                <h5 class="pb-1">مبلغ قابل پرداخت: {{ constructor(totalPrice - credit) }} تومان</h5>
                                <el-button class="float-right" type="primary" v-on:click="purchaesButton()">پرداخت</el-button>
                            </div>
                        </div>                        
                    </div>
                    <div class="col-12">
                    </div>
                </div>
            </div>
        </div>
</template>

<script>
import { SelectionChangeEvent, SelectionChangeEventReason } from 'd3-seating-chart';
import Ticket from './Ticket';
import shared from '../shared';

export default {
    components: {
        Ticket
    },
    computed: {
        credit : function(){ return this.$store.state.credit }
    },
    data: function () {
        return {
            d3sc: 0,
            timeShop: 0,
            time: '',
            listTickets: [],
            totalPrice: 0
        }
    },
    mounted: function() {
        const D3SeatingChart = require('d3-seating-chart/dist/d3SeatingChart.js').D3SeatingChart;
        this.d3sc = D3SeatingChart.attach(document.getElementById('x'));
        this.d3sc.registerSelectionChangeListener((e) => {
            console.log(e.selection); // All current selections
            this.listTickets = e.selection;
            this.totalPrice = e.selection.length * 5000;

            if(e.reason === SelectionChangeEventReason.SelectionChanged) {
                console.log('number of selected seats: ' + e.selection.length)
            } else if (e.reason === SelectionChangeEventReason.LockOverride) {
                alert('Some of the seats you had selected are now taken.');
            }
        });
    },
    created: function() {
        this.incrementShopTime();
        this.timer = setInterval(this.incrementShopTime, 1000);
    },
    methods: {
        goBack: function () {
            this.d3sc.goToBoard();
        },
        incrementShopTime() {
            if(this.timeShop >= 100)
                this.timeShop = 0;
            this.timeShop++;
        },
        constructor: shared.constructor,
        purchaesButton: function() {
            axios({url: '/api/payment/payir', method: 'POST' })
            .then(resp => {
                window.location.href = resp.data.payir_url;
            })
            .catch(err => {
                console.log(err);
            })
        }
    }
}
</script>

<style>

svg {
  border: none;
  display: block;
  margin: 0 auto;
}

[stage] {
  fill: #000;
}

[zoom-control] {
    fill: #888888;
}

[zoom-control] {
  cursor: pointer;
  fill: #566199;
}

[seat] {
  fill: #efefef;
}

[seat][locked] {
  fill: #888888;
}

[seat][locked="reserved"] {
  fill: #00bfff;
}

[seat][selected] {
  fill: #ffe100;
}

[seat]:not([selected]):not([locked]):hover {
  fill: #ddd;
  cursor: pointer;
}
</style>