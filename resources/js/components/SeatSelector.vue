<template>
          <div class="row">
              <div class="col-12">
              <el-progress :percentage="timeShop"></el-progress>

              </div>
              <div class="col-12 text-xs-center">
                <svg id="x" width="640" height="480" xmlns="http://www.w3.org/2000/svg">
                <g board>
	<rect stage x="92" y="370.3" width="465" height="94.7"/>
    <rect stage x="309" y="15" class="st2" width="31" height="339"/>
    <rect zoom-control="left" x="92" y="14.6" class="st1" width="205.5" height="339.6"/>
	<rect zoom-control="right" x="351.5" y="14.6" class="st1" width="205.5" height="339.6"/>
    <text transform="matrix(1 0 0 1 299.6465 417.6211)" class="st3 st4 st5">استیج</text>
    <text zoom-control="right" transform="matrix(1 0 0 1 430.5332 184.6211)" class="st3 st4 st5">راست</text>
    <text zoom-control="left" transform="matrix(1 0 0 1 178.5723 184.6211)" class="st3 st4 st5">چپ</text>
	<g seating-area="left" zoom-target="left">
		<rect seat id="1" x="92" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="2" x="134.3" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="3" x="176.5" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="4" x="218.8" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="5" x="262.5" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="6" x="92" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="7" x="134.3" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="8" x="176.5" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat="10" id="9" x="218.8" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="10" x="262.5" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="11" x="92" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="12" x="134.3" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="13" x="176.5" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="14" x="218.8" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="15" x="262.5" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="16" x="92" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="17" x="134.3" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="18" x="176.5" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="19" x="218.8" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="20" x="262.5" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="21" x="92" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="22" x="134.3" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="23" x="176.5" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="24" x="218.8" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="25" x="262.5" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat="10" id="26" x="92" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="27" x="134.3" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="28" x="176.5" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="29" x="218.8" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="30" x="262.5" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat="10" id="31" x="92" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="32" x="134.3" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="33" x="176.5" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="34" x="218.8" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="35" x="262.5" y="14.6" class="st0" width="35" height="42.3"/>
	</g>
	<g seating-area="right" zoom-target="right">
		<rect seat id="36" x="351.5" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="37" x="393.7" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="38" x="436" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="39" x="478.3" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="40" x="522" y="311.9" class="st0" width="35" height="42.3"/>
		<rect seat id="41" x="351.5" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="42" x="393.7" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="43" x="436" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="44" x="478.3" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="45" x="522" y="262.4" class="st0" width="35" height="42.3"/>
		<rect seat id="46" x="351.5" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="47" x="393.7" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="48" x="436" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="49" x="478.3" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="50" x="522" y="212.8" class="st0" width="35" height="42.3"/>
		<rect seat id="51" x="351.5" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="52" x="393.7" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="53" x="436" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="54" x="478.3" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="55" x="522" y="163.3" class="st0" width="35" height="42.3"/>
		<rect seat id="56" x="351.5" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="57" x="393.7" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="58" x="436" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="59" x="478.3" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="60" x="522" y="113.7" class="st0" width="35" height="42.3"/>
		<rect seat id="61" x="351.5" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="62" x="393.7" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="63" x="436" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="64" x="478.3" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="65" x="522" y="64.1" class="st0" width="35" height="42.3"/>
		<rect seat id="66" x="351.5" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="67" x="393.7" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="68" x="436" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="69" x="478.3" y="14.6" class="st0" width="35" height="42.3"/>
		<rect seat id="70" x="522" y="14.6" class="st0" width="35" height="42.3"/>
	</g>
</g>

                   </svg>
                   </div>
                   <div class="col-12 text-xs-center">
                        <el-button v-on:click="goBack()">برگشت</el-button>
                    </div>
            <div class="col-12">
                <h3 class="my-3"><i class="el-icon-s-fold mr-2"></i>لیست بلیت‌ها</h3>
                <div class="row">
                    <Ticket v-for="ticket in listTickets" :key="ticket.id" :ticket="ticket"></Ticket>
                    <div class="col-12" v-if="listTickets.length == 0">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                مکانی انتخاب نشده است.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12" v-if="listTickets.length > 0">
                <h3 class="my-3"><i class="el-icon-s-finance mr-2"></i>پرداخت</h3>
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5><i class="el-icon-s-claim mr-2"></i>فاکتور</h5>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-10">{{constructor(listTickets.length)}}x بلیت</div>
                                        <div class="col-2">{{ constructor(totalPrice) }} تومان</div>
                                    </div>
                                </li>
                                <li class="list-group-item disabled" aria-disabled="true">
                                    <div class="row">
                                        <div class="col-10">تخفیف</div>
                                        <div class="col-2">{{constructor(0)}} تومان</div>
                                    </div>
                                </li>
                            </ul>
                            <div class="card-footer">
                                <h6>مجموع: {{constructor(totalPrice)}} تومان</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5>تخفیف</h5>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="form-group">
                                        <label for="discountCode">کد تخفیف</label>
                                        <input type="text" class="form-control" id="discountCode">
                                    </div>
                                    <el-button class="float-right">اعمال</el-button>
                                </form>
                            </div>
                        </div>                        
                    </div>
                    <div class="col-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h5>پرداخت</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="pb-1">مبلغ فاکتور: {{ constructor(totalPrice) }} تومان</h6>
                                <h6 class="pb-1">اعتبار شما: {{ constructor(credit) }} تومان</h6>
                                <h5 class="pb-1">مبلغ قابل پرداخت: {{ constructor(totalPrice - credit) }} تومان</h5>
                                <el-button class="float-right" type="primary" v-on:click="purchaesButton()">پرداخت</el-button>
                            </div>
                        </div>                        
                    </div>
                    <div class="col-12">
                    </div>
                </div>
            </div>
        </div>
</template>

<script>
import { SelectionChangeEvent, SelectionChangeEventReason } from 'd3-seating-chart';
import Ticket from './Ticket';
import shared from '../shared';

export default {
    components: {
        Ticket
    },
    computed: {
        credit : function(){ return this.$store.state.credit }
    },
    data: function () {
        return {
            d3sc: 0,
            timeShop: 0,
            time: '',
            listTickets: [],
            totalPrice: 0
        }
    },
    mounted: function() {
        const D3SeatingChart = require('d3-seating-chart/dist/d3SeatingChart.js').D3SeatingChart;
        this.d3sc = D3SeatingChart.attach(document.getElementById('x'));
        this.d3sc.lock('[seat="10"]');
        this.d3sc.registerSelectionChangeListener((e) => {
            console.log(e.selection); // All current selections
            this.listTickets = e.selection;
            this.totalPrice = e.selection.length * 5000;

            if(e.reason === SelectionChangeEventReason.SelectionChanged) {
                console.log('number of selected seats: ' + e.selection.length)
            } else if (e.reason === SelectionChangeEventReason.LockOverride) {
                alert('Some of the seats you had selected are now taken.');
            }
        });
    },
    created: function() {
        this.incrementShopTime();
        this.timer = setInterval(this.incrementShopTime, 1000);
    },
    methods: {
        goBack: function () {
            this.d3sc.goToBoard();
        },
        incrementShopTime() {
            if(this.timeShop >= 100)
                this.timeShop = 0;
            this.timeShop++;
        },
        constructor: shared.constructor,
        purchaesButton: function() {
            axios({url: '/api/payment/payir', method: 'POST' })
            .then(resp => {
                window.location.href = resp.data.payir_url;
            })
            .catch(err => {
                console.log(err);
            })
        }
    }
}
</script>

<style>

svg {
  border: none;
  display: block;
  margin: 0 auto;
}

[stage] {
  fill: #000;
}

[zoom-control] {
    fill: #888888;
}

[zoom-control] {
  cursor: pointer;
  fill: #566199;
}

[seat] {
  fill: #efefef;
}

[seat][locked] {
  fill: #888888;
}

[seat][locked="reserved"] {
  fill: #00bfff;
}

[seat][selected] {
  fill: #ffe100;
}

[seat]:not([selected]):not([locked]):hover {
  fill: #ddd;
  cursor: pointer;
}

	.st3{fill:#FFFFFF;}
	.st4{font-family:'IRANSans';}
	.st5{font-size:20px;}
</style>